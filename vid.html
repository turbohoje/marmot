<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Time Lapse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      background: #05070b;
      color: #e5e7eb;
    }

    h1 {
      margin: 0 0 0.25rem 0;
      font-size: 1.5rem;
    }

    .subtitle {
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .grid-wrapper {
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    th, td {
      padding: 0.35rem 0.35rem 0.5rem 0.35rem;
      text-align: center;
      vertical-align: top;
    }

    thead th {
      font-weight: 600;
      font-size: 0.9rem;
      color: #9ca3af;
      position: sticky;
      top: 0;
      background: #05070b;
      z-index: 5;
    }

    .set-label {
      font-weight: 500;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .set-label-cell {
      position: sticky;
      left: 0;
      background: #05070b;
      z-index: 4;
    }

    video {
      max-width: 100%;
      border-radius: 0.5rem;
      display: block;
      width: 100%;
      height: auto;
      background: #020617;
      cursor: pointer;
    }

    .video-wrapper {
      border-radius: 0.75rem;
      padding: 0.35rem;
      background: #020617;
      border: 1px solid #111827;
      box-shadow: 0 6px 16px rgba(0,0,0,0.45);
    }

    .video-wrapper.empty {
      background: transparent;
      border-style: dashed;
      border-color: #1f2933;
      color: #4b5563;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 0.5rem;
    }

    .yesterday-col {
      background: radial-gradient(circle at top, rgba(248,250,252,0.10), transparent 55%);
      box-shadow: inset 0 0 0 1px rgba(248,250,252,0.08);
    }

    thead .yesterday-col {
      color: #e5e7eb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: rgba(248,250,252,0.06);
      border: 1px solid rgba(248,250,252,0.12);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #d1d5db;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34,197,94,0.7);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 0.75rem 0 0.5rem 0;
      font-size: 0.75rem;
      color: #9ca3af;
      align-items: center;
    }

    .legend-pill {
      border-radius: 999px;
      padding: 0.25rem 0.6rem;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(55,65,81,0.8);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .legend-swatch {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(248,250,252,0.9), rgba(248,250,252,0.2));
      box-shadow: 0 0 10px rgba(248,250,252,0.8);
    }

    .small {
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem 0.75rem 0.9rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      border: 1px solid #1f2937;
    }

    .modal-content video {
      max-width: 100%;
      max-height: 80vh;
      width: 100%;
      height: auto;
      border-radius: 0.5rem;
      cursor: default;
    }

    .modal-close {
      position: absolute;
      top: 0.4rem;
      right: 0.5rem;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      color: #e5e7eb;
    }

    .modal-close:hover {
      background: rgba(30,64,175,0.9);
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      h1 {
        font-size: 1.25rem;
      }
      .subtitle {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Weekly Time Lapse</h1>
    <div class="subtitle">
      daily time lapses
    </div>
    <div class="legend">
      <span class="badge">
        <span class="badge-dot"></span>
        Yesterday (latest)
      </span>
      <span class="legend-pill">
        <span class="legend-swatch"></span>
        Thumbnail 1 min into vid
      </span>
      <span class="small">
        
      </span>
    </div>
  </header>

  <main class="grid-wrapper">
    <table id="video-grid" aria-label="Weekly time lapse videos"></table>
  </main>

  <!-- Modal -->
  <div id="video-modal" class="modal-overlay">
    <div class="modal-content" id="modal-content">
      <button class="modal-close" id="modal-close" aria-label="Close video">&times;</button>
      <video id="modal-video" controls></video>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Base URL for your Cloudflare Worker proxying the GCS bucket
      const CDN_BASE = "https://cdn.justin-476.workers.dev/";

      // Cameras / sets
      const cameraConfig = [
        { label: "Camera 1", index: 1 },
        { label: "Camera 2", index: 2 },
        { label: "Camera 3", index: 3 },
      ];

      // Day ordering + labels
      const dayKeys = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
      const dayLabels = {
        sun: "Sun",
        mon: "Mon",
        tue: "Tue",
        wed: "Wed",
        thu: "Thu",
        fri: "Fri",
        sat: "Sat",
      };

      // Map from key to filename day name
      const fileDayNames = {
        sun: "Sunday",
        mon: "Monday",
        tue: "Tuesday",
        wed: "Wednesday",
        thu: "Thursday",
        fri: "Friday",
        sat: "Saturday",
      };

      function buildVideoUrl(cameraIndex, dayKey) {
        const dayName = fileDayNames[dayKey];
        return CDN_BASE + cameraIndex + "_" + dayName + ".mp4";
      }

      // Determine yesterday (based on browser's local time)
      function getYesterdayKey() {
        const today = new Date();
        const todayIndex = today.getDay(); // 0=Sun ... 6=Sat
        const yesterdayIndex = (todayIndex + 6) % 7;
        return dayKeys[yesterdayIndex];
      }

      const yesterdayKey = getYesterdayKey();

      // Seek to a preview time (default 60 seconds) and pause there
      function setupPreviewFrame(video, previewSeconds = 60) {
        video.addEventListener("loadedmetadata", () => {
          let target = previewSeconds;
          if (!isFinite(video.duration) || video.duration <= 0) {
            target = 1;
          } else if (video.duration <= previewSeconds) {
            target = Math.min(video.duration - 1, video.duration / 2);
            if (!isFinite(target) || target < 0) target = 1;
          }

          const onSeeked = () => {
            video.pause();
            video.removeEventListener("seeked", onSeeked);
          };

          video.addEventListener("seeked", onSeeked);
          video.currentTime = target;
        });

        video.autoplay = false;
      }

      // Handle missing / non-existent video file
      function setupErrorFallback(video, wrapper) {
        video.addEventListener("error", () => {
          wrapper.innerHTML = "";
          wrapper.classList.add("empty");
          wrapper.textContent = "Video not available";
        });
      }

      // Modal controls
      const modal = document.getElementById("video-modal");
      const modalVideo = document.getElementById("modal-video");
      const modalCloseBtn = document.getElementById("modal-close");
      const modalContent = document.getElementById("modal-content");

      function openModalWithSrc(src) {
        modalVideo.pause();
        modalVideo.src = src;
        modalVideo.currentTime = 0;
        modal.classList.add("open");

        const onMeta = () => {
          modalVideo.currentTime = 0;
          modalVideo.play().catch(() => {
            // autoplay might be blocked by browser; controls still usable
          });
          modalVideo.removeEventListener("loadedmetadata", onMeta);
        };
        modalVideo.addEventListener("loadedmetadata", onMeta);
      }

      function closeModal() {
        modal.classList.remove("open");
        modalVideo.pause();
        modalVideo.removeAttribute("src");
        modalVideo.load();
      }

      if (modalCloseBtn) {
        modalCloseBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          closeModal();
        });
      }

      // Click on overlay (but not on modal content) closes it
      if (modal) {
        modal.addEventListener("click", (e) => {
          if (!modalContent.contains(e.target)) {
            closeModal();
          }
        });
      }

      // ESC key closes modal
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("open")) {
          closeModal();
        }
      });

      // Build grid
      function buildGrid() {
        const table = document.getElementById("video-grid");
        table.innerHTML = "";

        // Header
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        const cornerTh = document.createElement("th");
        cornerTh.className = "set-label-cell";
        cornerTh.textContent = "Set";
        headerRow.appendChild(cornerTh);

        dayKeys.forEach((dayKey) => {
          const th = document.createElement("th");
          if (dayKey === yesterdayKey) th.classList.add("yesterday-col");
          th.textContent = dayLabels[dayKey];
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Body
        const tbody = document.createElement("tbody");

        cameraConfig.forEach((cam) => {
          const row = document.createElement("tr");

          // Label cell
          const labelCell = document.createElement("td");
          labelCell.className = "set-label-cell";
          const labelSpan = document.createElement("span");
          labelSpan.className = "set-label";
          labelSpan.textContent = cam.label;
          labelCell.appendChild(labelSpan);
          row.appendChild(labelCell);

          // One cell per day
          dayKeys.forEach((dayKey) => {
            const td = document.createElement("td");
            if (dayKey === yesterdayKey) td.classList.add("yesterday-col");

            const wrapper = document.createElement("div");
            wrapper.className = "video-wrapper";

            const video = document.createElement("video");
            const src = buildVideoUrl(cam.index, dayKey);

            const deepLinkId = `cam${cam.index}-${dayKey}`;
            td.dataset.deepLinkId = deepLinkId;
            video.dataset.deepLinkId = deepLinkId;
            video.src = src;
            video.controls = true;
            video.preload = "metadata";

            setupPreviewFrame(video, 60);
            setupErrorFallback(video, wrapper);

            // Clicking the small video opens the modal from the beginning
            video.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              // update hash for deep-linking
              window.location.hash = deepLinkId;
              openModalWithSrc(video.src);
            });

            wrapper.appendChild(video);
            td.appendChild(wrapper);
            row.appendChild(td);
          });

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
      }

      buildGrid();

      // Deep-link support:
      // Hash format: #cam{index}-{dayKey}, e.g. #cam1-mon
      function openFromHash() {
        const hash = window.location.hash.replace("#", "");
        if (!hash) return;

        const cell = document.querySelector(`[data-deep-link-id="${hash}"] video`);
        if (cell && cell.src) {
          // scroll into view and open
          cell.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
          openModalWithSrc(cell.src);
        }
      }

      // On first load
      openFromHash();

      // If hash changes later (e.g., user pastes a new deep link)
      window.addEventListener("hashchange", openFromHash);
    });
  </script>
</body>
</html>
