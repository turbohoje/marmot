<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Time Lapse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      background: #05070b;
      color: #e5e7eb;
    }

    h1 {
      margin: 0 0 0.25rem 0;
      font-size: 1.5rem;
    }

    .subtitle {
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .grid-wrapper {
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    th, td {
      padding: 0.35rem 0.35rem 0.5rem 0.35rem;
      text-align: center;
      vertical-align: top;
    }

    thead th {
      font-weight: 600;
      font-size: 0.9rem;
      color: #9ca3af;
      position: sticky;
      top: 0;
      background: #05070b;
      z-index: 5;
    }

    .set-label-cell {
      position: sticky;
      left: 0;
      background: #05070b;
      z-index: 4;
      font-weight: 500;
      white-space: nowrap;
    }

    .video-wrapper {
      border-radius: 0.75rem;
      padding: 0.35rem;
      background: #020617;
      border: 1px solid #111827;
      box-shadow: 0 6px 16px rgba(0,0,0,0.45);
    }

    .yesterday-col {
      background: radial-gradient(circle at top, rgba(248,250,252,0.10), transparent 55%);
      box-shadow: inset 0 0 0 1px rgba(248,250,252,0.08);
    }

    /* Sprite thumbnail */
    .thumb {
      width: 320px;
      height: 180px;
      border-radius: 0.5rem;
      background-image: url("https://marmot.troutlake.co/thumbs.png");
      background-repeat: no-repeat;
      background-size: 2240px 540px; /* 320*7 x 180*3 */
      cursor: pointer;
      position: relative;
      overflow: hidden;
      background-color: #020617;
    }

    .thumb::after {
      content: "▶";
      position: absolute;
      right: 8px;
      bottom: 4px;
      font-size: 1.1rem;
      color: rgba(249,250,251,0.85);
      text-shadow: 0 0 6px rgba(0,0,0,0.9);
      pointer-events: none;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: #020617;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
    }

    .modal-content video {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 0.5rem;
    }

    .modal-close {
      position: absolute;
      top: -12px;
      right: -12px;
      z-index: 200;
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: #e5e7eb;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    @media (max-width: 768px) {
      .thumb {
        width: 240px;
        height: 135px;
      }
      table {
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Weekly Time Lapse</h1>
    <div class="subtitle">daily time lapses (sprite thumbnails)</div>
  </header>

  <main class="grid-wrapper">
    <table id="video-grid"></table>
  </main>

  <!-- Modal -->
  <div id="video-modal" class="modal-overlay">
    <div class="modal-content" id="modal-content">
      <button class="modal-close" id="modal-close">&times;</button>
      <video id="modal-video" controls></video>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const CDN_BASE = "https://marmot.troutlake.co/";
      const THUMB_W = 320, THUMB_H = 180;

      const cameraConfig = [
        { label: "Camera 1", index: 1 },
        { label: "Camera 2", index: 2 },
        { label: "Camera 3", index: 3 },
      ];

      const dayKeys = ["sun","mon","tue","wed","thu","fri","sat"];
      const fileDayNames = {
        sun:"Sunday", mon:"Monday", tue:"Tuesday",
        wed:"Wednesday", thu:"Thursday", fri:"Friday", sat:"Saturday"
      };

      function buildVideoUrl(cam, dayKey) {
        return `${CDN_BASE}${cam}_${fileDayNames[dayKey]}.mp4`;
      }

      // Identify yesterday
      function getYesterdayKey() {
        const today = new Date().getDay();
        return dayKeys[(today + 6) % 7];
      }
      const yesterdayKey = getYesterdayKey();

      // Modal logic
      const modal = document.getElementById("video-modal");
      const modalVideo = document.getElementById("modal-video");
      const modalClose = document.getElementById("modal-close");
      const modalContent = document.getElementById("modal-content");

      function openModalWithSrc(src) {
        modalVideo.src = src;
        modalVideo.currentTime = 0;
        modal.classList.add("open");

        modalVideo.addEventListener("loadedmetadata", function handler() {
          modalVideo.currentTime = 0;
          modalVideo.play().catch(()=>{});
          modalVideo.removeEventListener("loadedmetadata", handler);
        });
      }

      function closeModal() {
        modal.classList.remove("open");
        modalVideo.pause();
        modalVideo.removeAttribute("src");
        modalVideo.load();

        // *** NEW: Clear URL hash ***
        history.replaceState(null, "", window.location.pathname);
      }

      modalClose.addEventListener("click", e => {
        e.stopPropagation();
        closeModal();
      });

      modal.addEventListener("click", e => {
        if (!modalContent.contains(e.target)) closeModal();
      });

      document.addEventListener("keydown", e => {
        if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
      });

      // Build the 3×7 grid
      function buildGrid() {
        const table = document.getElementById("video-grid");
        table.innerHTML = "";

        const thead = document.createElement("thead");
        const tr = document.createElement("tr");
        const corner = document.createElement("th");
        corner.textContent = "Set";
        corner.classList.add("set-label-cell");
        tr.appendChild(corner);

        dayKeys.forEach(dayKey => {
          const th = document.createElement("th");
          th.textContent = dayKey.toUpperCase();
          if (dayKey === yesterdayKey) th.classList.add("yesterday-col");
          tr.appendChild(th);
        });

        thead.appendChild(tr);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        cameraConfig.forEach(cam => {
          const row = document.createElement("tr");
          const labelCell = document.createElement("td");
          labelCell.classList.add("set-label-cell");
          labelCell.textContent = cam.label;
          row.appendChild(labelCell);

          dayKeys.forEach((dayKey, colIndex) => {
            const td = document.createElement("td");
            if (dayKey === yesterdayKey) td.classList.add("yesterday-col");

            const wrapper = document.createElement("div");
            wrapper.className = "video-wrapper";

            const thumb = document.createElement("div");
            thumb.className = "thumb";

            // Sprite coordinates
            const rowIndex = cam.index - 1;
            const offsetX = colIndex * THUMB_W;
            const offsetY = rowIndex * THUMB_H;

            thumb.style.backgroundPosition = `-${offsetX}px -${offsetY}px`;

            const deepId = `cam${cam.index}-${dayKey}`;
            td.dataset.deepLinkId = deepId;

            thumb.addEventListener("click", () => {
              const src = buildVideoUrl(cam.index, dayKey);
              window.location.hash = deepId;
              openModalWithSrc(src);
            });

            wrapper.appendChild(thumb);
            td.appendChild(wrapper);
            row.appendChild(td);
          });

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
      }

      buildGrid();

      // Handle deep links
      function openFromHash() {
        const hash = window.location.hash.substring(1);
        if (!hash) return;

        const m = hash.match(/^cam(\d+)-([a-z]{3})$/);
        if (!m) return;

        const cam = parseInt(m[1]);
        const day = m[2];
        openModalWithSrc(buildVideoUrl(cam, day));
      }

      openFromHash();
      window.addEventListener("hashchange", openFromHash);
    });
  </script>
</body>
</html>
